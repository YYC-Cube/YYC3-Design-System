name: Test Tokens, Build and Post OKLCH Report (Enhanced PR comment + Checks)

on:
  pull_request:
    paths:
      - 'design/tokens.json'
      - 'scripts/**'
      - 'style-dictionary.config.js'
  push:
    paths:
      - 'design/tokens.json'
      - 'scripts/**'
      - 'style-dictionary.config.js'

permissions:
  contents: read
  pull-requests: write
  actions: read
  checks: write

env:
  TOP_N: 5

jobs:
  test-build-report:
    name: Test, Build and Post OKLCH Report
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run OKLCH smoke test
        id: ok_test
        run: |
          echo "Running OKLCH smoke test..."
          npm run test:oklch
        continue-on-error: true

      - name: Run unit tests (Jest)
        id: unit_test
        run: |
          if npm run -s test; then
            echo "Unit tests passed"
          else
            echo "Unit tests failed"
            exit 1
          fi

      - name: Build tokens with Style Dictionary
        id: build_tokens
        run: |
          npm run build:tokens

      - name: Generate OKLCH report (JSON + MD)
        id: gen_report
        env:
          TOP_N: ${{ env.TOP_N }}
        run: |
          npm run report:oklch

      - name: Ensure reports exist
        run: |
          mkdir -p reports
          if [ ! -f reports/oklch-report.json ]; then
            echo '{"generatedAt":"","summary":{"total":0,"failures":0,"warnings":0},"results":[],"failures":[],"warnings":[]}' > reports/oklch-report.json
          fi
          if [ ! -f reports/oklch-report.md ]; then
            echo "# OKLCH report not generated" > reports/oklch-report.md
          fi

      - name: Upload OKLCH report artifact
        id: upload_artifact
        uses: actions/upload-artifact@v4
        with:
          name: oklch-report
          path: reports/

      - name: Build PR comment body
        id: build_comment
        run: |
          set -euo pipefail
          JSON="reports/oklch-report.json"
          TOP_N=${{ env.TOP_N }}

          total=$(jq -r '.summary.total // 0' "$JSON")
          failures=$(jq -r '.summary.failures // 0' "$JSON")
          warnings=$(jq -r '.summary.warnings // 0' "$JSON")
          generatedAt=$(jq -r '.generatedAt // ""' "$JSON")

          # Use jq to build the comment content to avoid bash variable scope issues
          jq -r --arg total "$total" \
                 --arg failures "$failures" \
                 --arg warnings "$warnings" \
                 --arg generatedAt "$generatedAt" \
                 --argjson n "$TOP_N" \
                 '.failures[0:$n] | .[] | "- **\(.path)**\n   - 原始值: `\(.source | @json)`\n   - 原因: **\(.reason)**\n   - 优先级分数: \(.priorityScore)\n"' \
                 "$JSON" > /tmp/failures.txt

          top_fail_md=""
          if [ "$failures" -gt 0 ]; then
            top_fail_md="### 失败摘要 (按优先级排序，显示 Top $TOP_N)\n\n$(cat /tmp/failures.txt)"
          fi

          jq -r --argjson n 3 '.failures[0:$n] | .[] | "- **\(.path)** — \(.reason)\n"' \
                 "$JSON" > /tmp/top3.txt

          top3_md=""
          if [ "$failures" -gt 0 ]; then
            top3_md="### 最关键的 3 项 (请优先处理)\n\n$(cat /tmp/top3.txt)"
          fi

          jq -r '.warnings[0:5] | .[] | "- **\(.path)**: \(.note)\n"' \
                 "$JSON" > /tmp/warnings.txt

          warn_md=""
          warn_count=$(jq '.warnings | length' "$JSON")
          if [ "$warn_count" -gt 0 ]; then
            warn_md="### 警告 (可能超出 sRGB 色域)\n\n$(cat /tmp/warnings.txt)"
          fi

          comment="# OKLCH -> HEX 转换报告\\n\\n"
          comment="${comment}**生成时间**: ${generatedAt}\\n\\n"
          comment="${comment}- 总色值: ${total}\\n"
          comment="${comment}- 失败: ${failures}\\n"
          comment="${comment}- 警告: ${warnings}\\n\\n"

          if [ -n "${top3_md}" ]; then
            comment="${comment}${top3_md}\\n"
          fi

          if [ -n "${top_fail_md}" ]; then
            comment="${comment}${top_fail_md}\\n"
          fi

          if [ -n "${warn_md}" ]; then
            comment="${comment}${warn_md}\\n"
          fi

          comment="${comment}---\\n\\n"
          comment="${comment}### 修复建议 (快速模板)\\n\\n"
          comment="${comment}当出现 \\\`missing_hex\\\` 或 \\\`parse_error\\\` 时，请按以下步骤修复：\\n\\n"
          comment="${comment}1. 在 \\\`design/tokens.json\\\` 对应 token 下补充 \\\`hex\\\` 字段，例如：\\n"
          comment="${comment}\\`\\`\\`json\\n"
          comment="${comment}{\\n"
          comment="${comment}  \\\"color\\\": {\\n"
          comment="${comment}    \\\"example\\\": {\\n"
          comment="${comment}      \\\"oklch\\\": \\\"oklch(0.6209 0.1801 348.1385)\\\",\\n"
          comment="${comment}      \\\"hex\\\": \\\"#d45a5f\\\"\\n"
          comment="${comment}    }\\n"
          comment="${comment}  }\\n"
          comment="${comment}\\`\\`\\`\\n\\n"
          comment="${comment}2. 若 OKLCH 字符串格式不规范，确保格式为 \\\`oklch(L C H)\\\` 或 \\\`oklch(L C H / a)\\\`，例如：\\\`oklch(0.6209 0.1801 348.1385)\\\`。\\n\\n"
          comment="${comment}3. 若颜色超出 sRGB 色域 (out_of_gamut)，请在设计工具中选择可映射到 sRGB 的近似颜色并补充 \\\`hex\\\`。\\n\\n"
          comment="${comment}4. 提交修改后，CI 会自动重新运行并在 PR 中更新报告。\\n\\n"

          comment="${comment}完整报告已作为 artifact 上传 (请在 Actions 页面下载)。\\n"

          MAX=60000
          len=${#comment}
          if [ "$len" -gt "$MAX" ]; then
            comment="${comment:0:$MAX}\n\n报告被截断，完整报告请下载 artifact."
          fi

          # Write to GITHUB_OUTPUT environment file (new syntax)
          echo "body=$comment" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Post or update PR comment with OKLCH summary
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.build_comment.outputs.body }}
          identifier: oklch-report-comment

      - name: Create GitHub Check with top-3 annotations
        id: create_check
        if: github.event_name == 'pull_request'
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          JSON="reports/oklch-report.json"
          owner_repo="${REPO}"
          owner=$(echo "$owner_repo" | cut -d'/' -f1)
          repo=$(echo "$owner_repo" | cut -d'/' -f2)

          # Build annotations array using jq to avoid bash scope issues
          annotations_json=$(jq -c --arg n 3 \
            '{
              annotations: [.failures[0:$n | to_number] | .[] | {
                path: "design/tokens.json",
                start_line: 1,
                end_line: 1,
                annotation_level: "failure",
                message: ("Reason: " + .reason + " | Score: " + (.priorityScore | tostring) + " | Source: " + (.source | @json))
              }]
            }' "$JSON")

          check_payload=$(jq -n \
            --arg name "OKLCH Color Conversion Check" \
            --arg head_sha "${GITHUB_SHA}" \
            --argjson annotations "$annotations_json" \
            '{
              name: $name,
              head_sha: $head_sha,
              status: "completed",
              conclusion: (if ($annotations.annotations | length) > 0 then "failure" else "success" end),
              output: {
                title: "OKLCH Conversion Results",
                summary: (if ($annotations.annotations | length) > 0 then (($annotations.annotations | length) | tostring + " failures detected") else "All conversions successful" end),
                annotations: $annotations.annotations
              }
            }')

          curl -s -X POST \
            -H "Authorization: token ${TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${REPO}/check-runs" \
            -d "$check_payload"

      - name: Fail job if failures exist
        if: steps.gen_report.outcome == 'failure'
        run: exit 1
