name: Test Coverage Report

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '18'
  COVERAGE_THRESHOLD: 80

jobs:
  coverage:
    name: Test Coverage Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm test -- --coverage --watchAll=false --collectCoverageFrom='src/**/*.{ts,tsx}' --collectCoverageFrom='!src/**/*.stories.{ts,tsx}' --collectCoverageFrom='!src/**/*.d.ts'

      - name: Check coverage threshold
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            TOTAL=$(cat coverage/coverage-summary.json | grep -oP '(?<="total":\{)[^}]*' | grep -oP '(?<="pct":)\d+' | head -1)
            STATEMENTS=$(cat coverage/coverage-summary.json | grep -oP '(?<="statements":\{)[^}]*' | grep -oP '(?<="pct":)\d+' | head -1)
            BRANCHES=$(cat coverage/coverage-summary.json | grep -oP '(?<="branches":\{)[^}]*' | grep -oP '(?<="pct":)\d+' | head -1)
            FUNCTIONS=$(cat coverage/coverage-summary.json | grep -oP '(?<="functions":\{)[^}]*' | grep -oP '(?<="pct":)\d+' | head -1)
            
            echo "Total coverage: $TOTAL%"
            echo "Statements: $STATEMENTS%"
            echo "Branches: $BRANCHES%"
            echo "Functions: $FUNCTIONS%"
            
            echo "TOTAL=$TOTAL" >> $GITHUB_ENV
            echo "STATEMENTS=$STATEMENTS" >> $GITHUB_ENV
            echo "BRANCHES=$BRANCHES" >> $GITHUB_ENV
            echo "FUNCTIONS=$FUNCTIONS" >> $GITHUB_ENV
            
            if [ "$TOTAL" -lt "${{ env.COVERAGE_THRESHOLD }}" ]; then
              echo "Coverage ($TOTAL%) is below threshold (${{ env.COVERAGE_THRESHOLD }}%)"
              exit 1
            fi
          else
            echo "Coverage report not found"
            exit 1
          fi

      - name: Generate coverage report
        run: |
          npm run test:coverage || true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Create coverage summary
        if: always()
        run: |
          echo "## Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total | ${{ env.TOTAL }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Statements | ${{ env.STATEMENTS }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Branches | ${{ env.BRANCHES }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Functions | ${{ env.FUNCTIONS }}% |" >> $GITHUB_STEP_SUMMARY

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        run: |
          echo "## Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total | ${{ env.TOTAL }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Statements | ${{ env.STATEMENTS }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Branches | ${{ env.BRANCHES }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Functions | ${{ env.FUNCTIONS }}% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Threshold: ${{ env.COVERAGE_THRESHOLD }}%" >> $GITHUB_STEP_SUMMARY

  coverage-comparison:
    name: Coverage Comparison
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm test -- --coverage --watchAll=false

      - name: Get current coverage
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            CURRENT=$(cat coverage/coverage-summary.json | grep -oP '(?<="total":\{)[^}]*' | grep -oP '(?<="pct":)\d+' | head -1)
            echo "Current coverage: $CURRENT%"
            echo "CURRENT=$CURRENT" >> $GITHUB_ENV
          fi

      - name: Get previous coverage
        run: |
          git checkout HEAD~1
          npm ci
          npm test -- --coverage --watchAll=false
          
          if [ -f "coverage/coverage-summary.json" ]; then
            PREVIOUS=$(cat coverage/coverage-summary.json | grep -oP '(?<="total":\{)[^}]*' | grep -oP '(?<="pct":)\d+' | head -1)
            echo "Previous coverage: $PREVIOUS%"
            echo "PREVIOUS=$PREVIOUS" >> $GITHUB_ENV
          fi

      - name: Compare coverage
        run: |
          echo "## Coverage Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Previous coverage: ${{ env.PREVIOUS }}%" >> $GITHUB_STEP_SUMMARY
          echo "- Current coverage: ${{ env.CURRENT }}%" >> $GITHUB_STEP_SUMMARY
          
          CHANGE=$((CURRENT - PREVIOUS))
          if [ $CHANGE -gt 0 ]; then
            echo "- Change: +$CHANGE% ✅" >> $GITHUB_STEP_SUMMARY
          elif [ $CHANGE -lt 0 ]; then
            echo "- Change: $CHANGE% ⚠️" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Change: No change" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on coverage change
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const change = parseInt(process.env.CURRENT) - parseInt(process.env.PREVIOUS);
            let emoji = '➖';
            if (change > 0) emoji = '✅';
            else if (change < 0) emoji = '⚠️';
            
            const body = `
            ## Coverage Comparison
            
            - Previous coverage: ${process.env.PREVIOUS}%
            - Current coverage: ${process.env.CURRENT}%
            - Change: ${change > 0 ? '+' : ''}${change}% ${emoji}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  coverage-by-file:
    name: Coverage by File
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm test -- --coverage --watchAll=false

      - name: Generate file coverage report
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            echo "## Coverage by File" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| File | Statements | Branches | Functions | Lines |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-----------|----------|-----------|-------|" >> $GITHUB_STEP_SUMMARY
            
            cat coverage/coverage-summary.json | jq -r '. | to_entries[] | select(.key | startswith("src/")) | "| \(.key) | \(.value.statements.pct)% | \(.value.branches.pct)% | \(.value.functions.pct)% | \(.value.lines.pct)% |"' >> $GITHUB_STEP_SUMMARY || true
          fi

      - name: Identify low coverage files
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            echo "## Files with Low Coverage (< 50%)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            cat coverage/coverage-summary.json | jq -r '. | to_entries[] | select(.key | startswith("src/")) | select(.value.statements.pct < 50) | "- \(.key): \(.value.statements.pct)%"' >> $GITHUB_STEP_SUMMARY || echo "No files with low coverage" >> $GITHUB_STEP_SUMMARY
          fi
