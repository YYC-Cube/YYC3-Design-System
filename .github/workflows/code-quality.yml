name: Code Quality Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '18'

jobs:
  code-standards:
    name: Code Standards Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run Prettier check
        run: npm run format:check || true

      - name: Check for TODO comments
        run: |
          TODO_COUNT=$(grep -r "TODO" src/ --include="*.ts" --include="*.tsx" | wc -l)
          echo "Found $TODO_COUNT TODO comments"
          echo "TODO_COUNT=$TODO_COUNT" >> $GITHUB_ENV

      - name: Report TODO comments
        if: env.TODO_COUNT > 0
        run: |
          echo "## TODO Comments Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          grep -rn "TODO" src/ --include="*.ts" --include="*.tsx" >> $GITHUB_STEP_SUMMARY || true

  complexity:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install complexity tools
        run: npm install -g eslint-complexity-report

      - name: Analyze complexity
        run: |
          npx eslint src/ --format json --output-file eslint-complexity.json || true

      - name: Upload complexity report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: complexity-report
          path: eslint-complexity.json
          retention-days: 7

  duplicate-code:
    name: Duplicate Code Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install jscpd
        run: npm install -g jscpd

      - name: Detect duplicate code
        run: |
          jscpd src/ --format json --output jscpd-report.json --threshold 10 || true

      - name: Upload duplicate code report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: duplicate-code-report
          path: jscpd-report.json
          retention-days: 7

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --json > npm-audit.json || true

      - name: Check for outdated dependencies
        run: npm outdated --json > npm-outdated.json || true

      - name: Upload audit reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-audit-reports
          path: |
            npm-audit.json
            npm-outdated.json
          retention-days: 7

  documentation-check:
    name: Documentation Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for missing documentation
        run: |
          UNDOCUMENTED=$(find src/ -name "*.ts" -o -name "*.tsx" | xargs grep -L "@description" | wc -l)
          echo "Found $UNDOCUMENTED files without @description"
          echo "UNDOCUMENTED=$UNDOCUMENTED" >> $GITHUB_ENV

      - name: Report undocumented files
        if: env.UNDOCUMENTED > 0
        run: |
          echo "## Undocumented Files Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          find src/ -name "*.ts" -o -name "*.tsx" | xargs grep -L "@description" >> $GITHUB_STEP_SUMMARY || true

  type-safety:
    name: Type Safety Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for any types
        run: |
          ANY_COUNT=$(grep -r ": any" src/ --include="*.ts" --include="*.tsx" | wc -l)
          echo "Found $ANY_COUNT 'any' types"
          echo "ANY_COUNT=$ANY_COUNT" >> $GITHUB_ENV

      - name: Report any types
        if: env.ANY_COUNT > 0
        run: |
          echo "## 'any' Types Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          grep -rn ": any" src/ --include="*.ts" --include="*.tsx" >> $GITHUB_STEP_SUMMARY || true
