name: Performance Monitoring

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 0 * * 0'

env:
  NODE_VERSION: '18'

jobs:
  bundle-analysis:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Analyze bundle size
        run: |
          if [ -d "dist" ]; then
            TOTAL_SIZE=$(du -sh dist | cut -f1)
            FILE_COUNT=$(find dist -type f | wc -l)
            LARGEST_FILE=$(find dist -type f -exec du -h {} + | sort -rh | head -1)
            
            echo "Total bundle size: $TOTAL_SIZE"
            echo "Total files: $FILE_COUNT"
            echo "Largest file: $LARGEST_FILE"
            
            echo "TOTAL_SIZE=$TOTAL_SIZE" >> $GITHUB_ENV
            echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV
            echo "LARGEST_FILE=$LARGEST_FILE" >> $GITHUB_ENV
          fi

      - name: Compare with previous build
        run: |
          echo "## Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Total bundle size: ${{ env.TOTAL_SIZE }}" >> $GITHUB_STEP_SUMMARY
          echo "- Total files: ${{ env.FILE_COUNT }}" >> $GITHUB_STEP_SUMMARY
          echo "- Largest file: ${{ env.LARGEST_FILE }}" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `
            ## Bundle Size Analysis
            
            - Total bundle size: ${process.env.TOTAL_SIZE}
            - Total files: ${process.env.FILE_COUNT}
            - Largest file: ${process.env.LARGEST_FILE}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  lighthouse-performance:
    name: Lighthouse Performance Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Start test server
        run: |
          npx http-server dist -p 8080 &
          sleep 5

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:8080/
          uploadArtifacts: true
          temporaryPublicStorage: true
          budgetPath: .github/lighthouse-budget.json

      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results
          path: .lighthouseci/
          retention-days: 30

      - name: Generate performance report
        if: always()
        run: |
          echo "## Lighthouse Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f ".lighthouseci/lhr-report.json" ]; then
            PERFORMANCE=$(cat .lighthouseci/lhr-report.json | jq -r '.categories.performance.score * 100' 2>/dev/null || echo "N/A")
            ACCESSIBILITY=$(cat .lighthouseci/lhr-report.json | jq -r '.categories.accessibility.score * 100' 2>/dev/null || echo "N/A")
            BEST_PRACTICES=$(cat .lighthouseci/lhr-report.json | jq -r '.categories["best-practices"].score * 100' 2>/dev/null || echo "N/A")
            SEO=$(cat .lighthouseci/lhr-report.json | jq -r '.categories.seo.score * 100' 2>/dev/null || echo "N/A")
            
            echo "- Performance: $PERFORMANCE%" >> $GITHUB_STEP_SUMMARY
            echo "- Accessibility: $ACCESSIBILITY%" >> $GITHUB_STEP_SUMMARY
            echo "- Best Practices: $BEST_PRACTICES%" >> $GITHUB_STEP_SUMMARY
            echo "- SEO: $SEO%" >> $GITHUB_STEP_SUMMARY
          fi

  build-time-tracking:
    name: Build Time Tracking
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Track build time
        run: |
          START_TIME=$(date +%s)
          npm run build
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - START_TIME))
          
          echo "Build time: $BUILD_TIME seconds"
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV

      - name: Report build time
        run: |
          echo "## Build Time" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Total build time: ${{ env.BUILD_TIME }} seconds" >> $GITHUB_STEP_SUMMARY

  dependency-size:
    name: Dependency Size Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install size-limit
        run: npm install -g size-limit

      - name: Analyze dependency sizes
        run: |
          if [ -f "package.json" ]; then
            npm list --depth=0 --json > dependency-list.json
            cat dependency-list.json | jq -r '.dependencies | to_entries | .[] | "\(.key): \(.value.version)"' > dependencies.txt
            
            TOTAL_SIZE=$(du -sh node_modules | cut -f1)
            DEP_COUNT=$(cat dependencies.txt | wc -l)
            
            echo "Total dependency size: $TOTAL_SIZE"
            echo "Total dependencies: $DEP_COUNT"
            
            echo "TOTAL_SIZE=$TOTAL_SIZE" >> $GITHUB_ENV
            echo "DEP_COUNT=$DEP_COUNT" >> $GITHUB_ENV
          fi

      - name: Report dependency sizes
        run: |
          echo "## Dependency Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Total dependency size: ${{ env.TOTAL_SIZE }}" >> $GITHUB_STEP_SUMMARY
          echo "- Total dependencies: ${{ env.DEP_COUNT }}" >> $GITHUB_STEP_SUMMARY

  performance-regression:
    name: Performance Regression Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build current version
        run: |
          npm run build
          CURRENT_SIZE=$(du -sh dist | cut -f1)
          echo "CURRENT_SIZE=$CURRENT_SIZE" >> $GITHUB_ENV

      - name: Build previous version
        run: |
          git checkout HEAD~1
          npm ci
          npm run build
          PREV_SIZE=$(du -sh dist | cut -f1)
          echo "PREV_SIZE=$PREV_SIZE" >> $GITHUB_ENV

      - name: Compare sizes
        run: |
          echo "## Performance Regression Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Previous build size: ${{ env.PREV_SIZE }}" >> $GITHUB_STEP_SUMMARY
          echo "- Current build size: ${{ env.CURRENT_SIZE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Size change detected. Please review." >> $GITHUB_STEP_SUMMARY

      - name: Comment on size change
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `
            ## Performance Regression Check
            
            - Previous build size: ${process.env.PREV_SIZE}
            - Current build size: ${process.env.CURRENT_SIZE}
            
            Please review any significant size changes.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
