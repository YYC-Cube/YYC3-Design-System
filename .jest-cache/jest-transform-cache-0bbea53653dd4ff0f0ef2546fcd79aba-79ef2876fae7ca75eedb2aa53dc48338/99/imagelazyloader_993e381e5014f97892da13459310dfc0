ab85fe7bbaeb3dbdcdc9848f4b15db64
"use strict";
/**
 * @file 图片懒加载工具
 * @description 提供基于 IntersectionObserver 的图片懒加载功能
 * @module utils/image-lazy-loader
 * @author YYC³
 * @version 1.0.0
 * @created 2026-02-22
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.clearImageCache = exports.destroyAllLazyImages = exports.getLazyImageStats = exports.createLazyImageWithPlaceholder = exports.createProgressiveImageLoader = exports.createLazyImageBatchLoader = exports.preloadLazyImage = exports.resetLazyImage = exports.observeAllLazyImages = exports.unobserveLazyImage = exports.loadImage = exports.observeLazyImage = exports.createLazyImageObserver = exports.getLazyImageConfig = exports.setLazyImageConfig = void 0;
const defaultConfig = {
    enabled: true,
    rootMargin: '50px',
    threshold: 0.01,
    placeholder: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PC9zdmc+',
    errorPlaceholder: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZmZjZGNkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTk5OTkiIGZvbnQtc2l6ZT0iMTQiPuaXoDwvdGV4dD48L3N2Zz4=',
    retryCount: 3,
    retryDelay: 1000,
};
let globalConfig = { ...defaultConfig };
const observerMap = new WeakMap();
const setLazyImageConfig = (config) => {
    globalConfig = { ...globalConfig, ...config };
};
exports.setLazyImageConfig = setLazyImageConfig;
const getLazyImageConfig = () => {
    return { ...globalConfig };
};
exports.getLazyImageConfig = getLazyImageConfig;
const createLazyImageObserver = (callback, options) => {
    const defaultOptions = {
        rootMargin: globalConfig.rootMargin,
        threshold: globalConfig.threshold,
    };
    return new IntersectionObserver(callback, { ...defaultOptions, ...options });
};
exports.createLazyImageObserver = createLazyImageObserver;
const observeLazyImage = (element, options) => {
    if (!globalConfig.enabled || !('IntersectionObserver' in window)) {
        (0, exports.loadImage)(element, options);
        return () => { };
    }
    const dataSrc = element.getAttribute('data-src');
    if (!dataSrc) {
        return () => { };
    }
    const observer = (0, exports.createLazyImageObserver)((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting) {
                (0, exports.loadImage)(entry.target, options);
                observer.unobserve(entry.target);
            }
        });
    });
    observer.observe(element);
    observerMap.set(element, observer);
    return () => {
        observer.unobserve(element);
        observerMap.delete(element);
    };
};
exports.observeLazyImage = observeLazyImage;
const loadImage = (element, options, retryCount = 0) => {
    const dataSrc = element.getAttribute('data-src');
    if (!dataSrc) {
        return;
    }
    const { placeholder = globalConfig.placeholder, errorPlaceholder = globalConfig.errorPlaceholder, retryCount: maxRetries = globalConfig.retryCount, retryDelay = globalConfig.retryDelay, onLoad, onError, } = options || {};
    const originalSrc = element.src;
    element.src = placeholder;
    const img = new Image();
    img.onload = () => {
        element.src = dataSrc;
        element.removeAttribute('data-src');
        element.classList.add('lazy-loaded');
        onLoad?.(element);
    };
    img.onerror = () => {
        if (retryCount < maxRetries) {
            setTimeout(() => {
                (0, exports.loadImage)(element, options, retryCount + 1);
            }, retryDelay);
        }
        else {
            element.src = errorPlaceholder;
            element.classList.add('lazy-error');
            onError?.(element);
        }
    };
    img.src = dataSrc;
};
exports.loadImage = loadImage;
const unobserveLazyImage = (element) => {
    const observer = observerMap.get(element);
    if (observer) {
        observer.unobserve(element);
        observerMap.delete(element);
    }
};
exports.unobserveLazyImage = unobserveLazyImage;
const observeAllLazyImages = (selector = 'img[data-src]', options) => {
    const images = document.querySelectorAll(selector);
    const unobserveFunctions = [];
    images.forEach((img) => {
        unobserveFunctions.push((0, exports.observeLazyImage)(img, options));
    });
    return () => {
        unobserveFunctions.forEach((unobserve) => unobserve());
    };
};
exports.observeAllLazyImages = observeAllLazyImages;
const resetLazyImage = (element, originalSrc) => {
    element.src = globalConfig.placeholder;
    element.setAttribute('data-src', originalSrc);
    element.classList.remove('lazy-loaded', 'lazy-error');
    (0, exports.unobserveLazyImage)(element);
};
exports.resetLazyImage = resetLazyImage;
const preloadLazyImage = (src, options) => {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
            options?.onLoad?.(img);
            resolve(img);
        };
        img.onerror = () => {
            options?.onError?.(img);
            reject(new Error(`Failed to load image: ${src}`));
        };
        img.src = src;
    });
};
exports.preloadLazyImage = preloadLazyImage;
const createLazyImageBatchLoader = (batchSize = 5, delay = 100) => {
    let queue = [];
    let processing = false;
    const processBatch = async () => {
        if (processing || queue.length === 0) {
            return;
        }
        processing = true;
        const batch = queue.splice(0, batchSize);
        await Promise.all(batch.map((img) => {
            return new Promise((resolve) => {
                const dataSrc = img.getAttribute('data-src');
                if (dataSrc) {
                    const tempImg = new Image();
                    tempImg.onload = () => {
                        img.src = dataSrc;
                        img.removeAttribute('data-src');
                        img.classList.add('lazy-loaded');
                        resolve();
                    };
                    tempImg.onerror = () => {
                        img.src = globalConfig.errorPlaceholder;
                        img.classList.add('lazy-error');
                        resolve();
                    };
                    tempImg.src = dataSrc;
                }
                else {
                    resolve();
                }
            });
        }));
        processing = false;
        if (queue.length > 0) {
            setTimeout(processBatch, delay);
        }
    };
    return {
        add: (img) => {
            queue.push(img);
            processBatch();
        },
        addBatch: (images) => {
            queue.push(...images);
            processBatch();
        },
        clear: () => {
            queue = [];
        },
        getQueueSize: () => queue.length,
    };
};
exports.createLazyImageBatchLoader = createLazyImageBatchLoader;
const createProgressiveImageLoader = (lowQualitySrc, highQualitySrc, element, options) => {
    element.src = lowQualitySrc;
    element.classList.add('progressive-loading');
    const highQualityImg = new Image();
    highQualityImg.onload = () => {
        element.src = highQualitySrc;
        element.classList.remove('progressive-loading');
        element.classList.add('progressive-loaded');
        options?.onLoad?.(element);
    };
    highQualityImg.onerror = () => {
        element.classList.remove('progressive-loading');
        element.classList.add('progressive-error');
        options?.onError?.(element);
    };
    highQualityImg.src = highQualitySrc;
};
exports.createProgressiveImageLoader = createProgressiveImageLoader;
const createLazyImageWithPlaceholder = (element, placeholderColor = '#f0f0f0', placeholderText = 'Loading...') => {
    const canvas = document.createElement('canvas');
    canvas.width = 100;
    canvas.height = 100;
    const ctx = canvas.getContext('2d');
    if (ctx) {
        ctx.fillStyle = placeholderColor;
        ctx.fillRect(0, 0, 100, 100);
        ctx.fillStyle = '#999';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(placeholderText, 50, 50);
        element.src = canvas.toDataURL('image/png');
    }
    (0, exports.observeLazyImage)(element);
};
exports.createLazyImageWithPlaceholder = createLazyImageWithPlaceholder;
const getLazyImageStats = () => {
    const images = document.querySelectorAll('img[data-src], img.lazy-loaded, img.lazy-error');
    const total = images.length;
    const loaded = document.querySelectorAll('img.lazy-loaded').length;
    const error = document.querySelectorAll('img.lazy-error').length;
    const pending = total - loaded - error;
    return { total, loaded, error, pending };
};
exports.getLazyImageStats = getLazyImageStats;
const destroyAllLazyImages = () => {
    const images = document.querySelectorAll('img[data-src]');
    images.forEach((img) => {
        (0, exports.unobserveLazyImage)(img);
    });
};
exports.destroyAllLazyImages = destroyAllLazyImages;
const clearImageCache = () => {
    const images = document.querySelectorAll('img[data-src]');
    images.forEach((img) => {
        (0, exports.unobserveLazyImage)(img);
        img.src = '';
        img.removeAttribute('data-src');
    });
};
exports.clearImageCache = clearImageCache;
exports.default = {
    setLazyImageConfig: exports.setLazyImageConfig,
    getLazyImageConfig: exports.getLazyImageConfig,
    observeLazyImage: exports.observeLazyImage,
    unobserveLazyImage: exports.unobserveLazyImage,
    observeAllLazyImages: exports.observeAllLazyImages,
    loadImage: exports.loadImage,
    resetLazyImage: exports.resetLazyImage,
    preloadLazyImage: exports.preloadLazyImage,
    createLazyImageBatchLoader: exports.createLazyImageBatchLoader,
    createProgressiveImageLoader: exports.createProgressiveImageLoader,
    createLazyImageWithPlaceholder: exports.createLazyImageWithPlaceholder,
    getLazyImageStats: exports.getLazyImageStats,
    destroyAllLazyImages: exports.destroyAllLazyImages,
    clearImageCache: exports.clearImageCache,
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3lhbnl1L0Rvd25sb2Fkcy95eWMzLURlc2lnbi1TeXN0ZW0vc3JjL3V0aWxzL2ltYWdlLWxhenktbG9hZGVyLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7OztHQU9HOzs7QUF1QkgsTUFBTSxhQUFhLEdBQW9CO0lBQ3JDLE9BQU8sRUFBRSxJQUFJO0lBQ2IsVUFBVSxFQUFFLE1BQU07SUFDbEIsU0FBUyxFQUFFLElBQUk7SUFDZixXQUFXLEVBQ1QsNExBQTRMO0lBQzlMLGdCQUFnQixFQUNkLGdWQUFnVjtJQUNsVixVQUFVLEVBQUUsQ0FBQztJQUNiLFVBQVUsRUFBRSxJQUFJO0NBQ2pCLENBQUM7QUFFRixJQUFJLFlBQVksR0FBb0IsRUFBRSxHQUFHLGFBQWEsRUFBRSxDQUFDO0FBRXpELE1BQU0sV0FBVyxHQUFHLElBQUksT0FBTyxFQUFpQyxDQUFDO0FBRTFELE1BQU0sa0JBQWtCLEdBQUcsQ0FBQyxNQUFnQyxFQUFRLEVBQUU7SUFDM0UsWUFBWSxHQUFHLEVBQUUsR0FBRyxZQUFZLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQztBQUNoRCxDQUFDLENBQUM7QUFGVyxRQUFBLGtCQUFrQixzQkFFN0I7QUFFSyxNQUFNLGtCQUFrQixHQUFHLEdBQW9CLEVBQUU7SUFDdEQsT0FBTyxFQUFFLEdBQUcsWUFBWSxFQUFFLENBQUM7QUFDN0IsQ0FBQyxDQUFDO0FBRlcsUUFBQSxrQkFBa0Isc0JBRTdCO0FBRUssTUFBTSx1QkFBdUIsR0FBRyxDQUNyQyxRQUFzQyxFQUN0QyxPQUFrQyxFQUNaLEVBQUU7SUFDeEIsTUFBTSxjQUFjLEdBQTZCO1FBQy9DLFVBQVUsRUFBRSxZQUFZLENBQUMsVUFBVTtRQUNuQyxTQUFTLEVBQUUsWUFBWSxDQUFDLFNBQVM7S0FDbEMsQ0FBQztJQUVGLE9BQU8sSUFBSSxvQkFBb0IsQ0FBQyxRQUFRLEVBQUUsRUFBRSxHQUFHLGNBQWMsRUFBRSxHQUFHLE9BQU8sRUFBRSxDQUFDLENBQUM7QUFDL0UsQ0FBQyxDQUFDO0FBVlcsUUFBQSx1QkFBdUIsMkJBVWxDO0FBRUssTUFBTSxnQkFBZ0IsR0FBRyxDQUM5QixPQUF5QixFQUN6QixPQUEwQixFQUNaLEVBQUU7SUFDaEIsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDLHNCQUFzQixJQUFJLE1BQU0sQ0FBQyxFQUFFLENBQUM7UUFDakUsSUFBQSxpQkFBUyxFQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztRQUM1QixPQUFPLEdBQUcsRUFBRSxHQUFFLENBQUMsQ0FBQztJQUNsQixDQUFDO0lBRUQsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNqRCxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDYixPQUFPLEdBQUcsRUFBRSxHQUFFLENBQUMsQ0FBQztJQUNsQixDQUFDO0lBRUQsTUFBTSxRQUFRLEdBQUcsSUFBQSwrQkFBdUIsRUFBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQ25ELE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUN4QixJQUFJLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztnQkFDekIsSUFBQSxpQkFBUyxFQUFDLEtBQUssQ0FBQyxNQUEwQixFQUFFLE9BQU8sQ0FBQyxDQUFDO2dCQUNyRCxRQUFRLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNuQyxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDMUIsV0FBVyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFFbkMsT0FBTyxHQUFHLEVBQUU7UUFDVixRQUFRLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzVCLFdBQVcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDOUIsQ0FBQyxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBOUJXLFFBQUEsZ0JBQWdCLG9CQThCM0I7QUFFSyxNQUFNLFNBQVMsR0FBRyxDQUN2QixPQUF5QixFQUN6QixPQUEwQixFQUMxQixhQUFxQixDQUFDLEVBQ2hCLEVBQUU7SUFDUixNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ2pELElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNiLE9BQU87SUFDVCxDQUFDO0lBRUQsTUFBTSxFQUNKLFdBQVcsR0FBRyxZQUFZLENBQUMsV0FBVyxFQUN0QyxnQkFBZ0IsR0FBRyxZQUFZLENBQUMsZ0JBQWdCLEVBQ2hELFVBQVUsRUFBRSxVQUFVLEdBQUcsWUFBWSxDQUFDLFVBQVUsRUFDaEQsVUFBVSxHQUFHLFlBQVksQ0FBQyxVQUFVLEVBQ3BDLE1BQU0sRUFDTixPQUFPLEdBQ1IsR0FBRyxPQUFPLElBQUksRUFBRSxDQUFDO0lBRWxCLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUM7SUFDaEMsT0FBTyxDQUFDLEdBQUcsR0FBRyxXQUFXLENBQUM7SUFFMUIsTUFBTSxHQUFHLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQztJQUV4QixHQUFHLENBQUMsTUFBTSxHQUFHLEdBQUcsRUFBRTtRQUNoQixPQUFPLENBQUMsR0FBRyxHQUFHLE9BQU8sQ0FBQztRQUN0QixPQUFPLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3BDLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3JDLE1BQU0sRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3BCLENBQUMsQ0FBQztJQUVGLEdBQUcsQ0FBQyxPQUFPLEdBQUcsR0FBRyxFQUFFO1FBQ2pCLElBQUksVUFBVSxHQUFHLFVBQVUsRUFBRSxDQUFDO1lBQzVCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2QsSUFBQSxpQkFBUyxFQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsVUFBVSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzlDLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUNqQixDQUFDO2FBQU0sQ0FBQztZQUNOLE9BQU8sQ0FBQyxHQUFHLEdBQUcsZ0JBQWdCLENBQUM7WUFDL0IsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDcEMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDckIsQ0FBQztJQUNILENBQUMsQ0FBQztJQUVGLEdBQUcsQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDO0FBQ3BCLENBQUMsQ0FBQztBQTVDVyxRQUFBLFNBQVMsYUE0Q3BCO0FBRUssTUFBTSxrQkFBa0IsR0FBRyxDQUFDLE9BQXlCLEVBQVEsRUFBRTtJQUNwRSxNQUFNLFFBQVEsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzFDLElBQUksUUFBUSxFQUFFLENBQUM7UUFDYixRQUFRLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzVCLFdBQVcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDOUIsQ0FBQztBQUNILENBQUMsQ0FBQztBQU5XLFFBQUEsa0JBQWtCLHNCQU03QjtBQUVLLE1BQU0sb0JBQW9CLEdBQUcsQ0FDbEMsV0FBbUIsZUFBZSxFQUNsQyxPQUEwQixFQUNaLEVBQUU7SUFDaEIsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLGdCQUFnQixDQUFtQixRQUFRLENBQUMsQ0FBQztJQUNyRSxNQUFNLGtCQUFrQixHQUFzQixFQUFFLENBQUM7SUFFakQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1FBQ3JCLGtCQUFrQixDQUFDLElBQUksQ0FBQyxJQUFBLHdCQUFnQixFQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQzFELENBQUMsQ0FBQyxDQUFDO0lBRUgsT0FBTyxHQUFHLEVBQUU7UUFDVixrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUM7SUFDekQsQ0FBQyxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBZFcsUUFBQSxvQkFBb0Isd0JBYy9CO0FBRUssTUFBTSxjQUFjLEdBQUcsQ0FBQyxPQUF5QixFQUFFLFdBQW1CLEVBQVEsRUFBRTtJQUNyRixPQUFPLENBQUMsR0FBRyxHQUFHLFlBQVksQ0FBQyxXQUFXLENBQUM7SUFDdkMsT0FBTyxDQUFDLFlBQVksQ0FBQyxVQUFVLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDOUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsYUFBYSxFQUFFLFlBQVksQ0FBQyxDQUFDO0lBQ3RELElBQUEsMEJBQWtCLEVBQUMsT0FBTyxDQUFDLENBQUM7QUFDOUIsQ0FBQyxDQUFDO0FBTFcsUUFBQSxjQUFjLGtCQUt6QjtBQUVLLE1BQU0sZ0JBQWdCLEdBQUcsQ0FDOUIsR0FBVyxFQUNYLE9BQTBCLEVBQ0MsRUFBRTtJQUM3QixPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1FBQ3JDLE1BQU0sR0FBRyxHQUFHLElBQUksS0FBSyxFQUFFLENBQUM7UUFFeEIsR0FBRyxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7WUFDaEIsT0FBTyxFQUFFLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3ZCLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNmLENBQUMsQ0FBQztRQUVGLEdBQUcsQ0FBQyxPQUFPLEdBQUcsR0FBRyxFQUFFO1lBQ2pCLE9BQU8sRUFBRSxPQUFPLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN4QixNQUFNLENBQUMsSUFBSSxLQUFLLENBQUMseUJBQXlCLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNwRCxDQUFDLENBQUM7UUFFRixHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztJQUNoQixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQztBQW5CVyxRQUFBLGdCQUFnQixvQkFtQjNCO0FBRUssTUFBTSwwQkFBMEIsR0FBRyxDQUFDLFlBQW9CLENBQUMsRUFBRSxRQUFnQixHQUFHLEVBQUUsRUFBRTtJQUN2RixJQUFJLEtBQUssR0FBdUIsRUFBRSxDQUFDO0lBQ25DLElBQUksVUFBVSxHQUFHLEtBQUssQ0FBQztJQUV2QixNQUFNLFlBQVksR0FBRyxLQUFLLElBQUksRUFBRTtRQUM5QixJQUFJLFVBQVUsSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQ3JDLE9BQU87UUFDVCxDQUFDO1FBRUQsVUFBVSxHQUFHLElBQUksQ0FBQztRQUNsQixNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUV6QyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQ2YsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ2hCLE9BQU8sSUFBSSxPQUFPLENBQU8sQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDbkMsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDN0MsSUFBSSxPQUFPLEVBQUUsQ0FBQztvQkFDWixNQUFNLE9BQU8sR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDO29CQUM1QixPQUFPLENBQUMsTUFBTSxHQUFHLEdBQUcsRUFBRTt3QkFDcEIsR0FBRyxDQUFDLEdBQUcsR0FBRyxPQUFPLENBQUM7d0JBQ2xCLEdBQUcsQ0FBQyxlQUFlLENBQUMsVUFBVSxDQUFDLENBQUM7d0JBQ2hDLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO3dCQUNqQyxPQUFPLEVBQUUsQ0FBQztvQkFDWixDQUFDLENBQUM7b0JBQ0YsT0FBTyxDQUFDLE9BQU8sR0FBRyxHQUFHLEVBQUU7d0JBQ3JCLEdBQUcsQ0FBQyxHQUFHLEdBQUcsWUFBWSxDQUFDLGdCQUFnQixDQUFDO3dCQUN4QyxHQUFHLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQzt3QkFDaEMsT0FBTyxFQUFFLENBQUM7b0JBQ1osQ0FBQyxDQUFDO29CQUNGLE9BQU8sQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDO2dCQUN4QixDQUFDO3FCQUFNLENBQUM7b0JBQ04sT0FBTyxFQUFFLENBQUM7Z0JBQ1osQ0FBQztZQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQ0gsQ0FBQztRQUVGLFVBQVUsR0FBRyxLQUFLLENBQUM7UUFFbkIsSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3JCLFVBQVUsQ0FBQyxZQUFZLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbEMsQ0FBQztJQUNILENBQUMsQ0FBQztJQUVGLE9BQU87UUFDTCxHQUFHLEVBQUUsQ0FBQyxHQUFxQixFQUFFLEVBQUU7WUFDN0IsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNoQixZQUFZLEVBQUUsQ0FBQztRQUNqQixDQUFDO1FBQ0QsUUFBUSxFQUFFLENBQUMsTUFBMEIsRUFBRSxFQUFFO1lBQ3ZDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQztZQUN0QixZQUFZLEVBQUUsQ0FBQztRQUNqQixDQUFDO1FBQ0QsS0FBSyxFQUFFLEdBQUcsRUFBRTtZQUNWLEtBQUssR0FBRyxFQUFFLENBQUM7UUFDYixDQUFDO1FBQ0QsWUFBWSxFQUFFLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNO0tBQ2pDLENBQUM7QUFDSixDQUFDLENBQUM7QUExRFcsUUFBQSwwQkFBMEIsOEJBMERyQztBQUVLLE1BQU0sNEJBQTRCLEdBQUcsQ0FDMUMsYUFBcUIsRUFDckIsY0FBc0IsRUFDdEIsT0FBeUIsRUFDekIsT0FBMEIsRUFDcEIsRUFBRTtJQUNSLE9BQU8sQ0FBQyxHQUFHLEdBQUcsYUFBYSxDQUFDO0lBQzVCLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLENBQUM7SUFFN0MsTUFBTSxjQUFjLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQztJQUVuQyxjQUFjLENBQUMsTUFBTSxHQUFHLEdBQUcsRUFBRTtRQUMzQixPQUFPLENBQUMsR0FBRyxHQUFHLGNBQWMsQ0FBQztRQUM3QixPQUFPLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQ2hELE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDNUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzdCLENBQUMsQ0FBQztJQUVGLGNBQWMsQ0FBQyxPQUFPLEdBQUcsR0FBRyxFQUFFO1FBQzVCLE9BQU8sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFDaEQsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUMzQyxPQUFPLEVBQUUsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDOUIsQ0FBQyxDQUFDO0lBRUYsY0FBYyxDQUFDLEdBQUcsR0FBRyxjQUFjLENBQUM7QUFDdEMsQ0FBQyxDQUFDO0FBekJXLFFBQUEsNEJBQTRCLGdDQXlCdkM7QUFFSyxNQUFNLDhCQUE4QixHQUFHLENBQzVDLE9BQXlCLEVBQ3pCLG1CQUEyQixTQUFTLEVBQ3BDLGtCQUEwQixZQUFZLEVBQ2hDLEVBQUU7SUFDUixNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2hELE1BQU0sQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDO0lBQ25CLE1BQU0sQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDO0lBQ3BCLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFcEMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNSLEdBQUcsQ0FBQyxTQUFTLEdBQUcsZ0JBQWdCLENBQUM7UUFDakMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUU3QixHQUFHLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQztRQUN2QixHQUFHLENBQUMsSUFBSSxHQUFHLFlBQVksQ0FBQztRQUN4QixHQUFHLENBQUMsU0FBUyxHQUFHLFFBQVEsQ0FBQztRQUN6QixHQUFHLENBQUMsWUFBWSxHQUFHLFFBQVEsQ0FBQztRQUM1QixHQUFHLENBQUMsUUFBUSxDQUFDLGVBQWUsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFdEMsT0FBTyxDQUFDLEdBQUcsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFFRCxJQUFBLHdCQUFnQixFQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzVCLENBQUMsQ0FBQztBQXhCVyxRQUFBLDhCQUE4QixrQ0F3QnpDO0FBRUssTUFBTSxpQkFBaUIsR0FBRyxHQUsvQixFQUFFO0lBQ0YsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLGdCQUFnQixDQUN0QyxnREFBZ0QsQ0FDakQsQ0FBQztJQUNGLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDNUIsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLGdCQUFnQixDQUFtQixpQkFBaUIsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUNyRixNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsZ0JBQWdCLENBQW1CLGdCQUFnQixDQUFDLENBQUMsTUFBTSxDQUFDO0lBQ25GLE1BQU0sT0FBTyxHQUFHLEtBQUssR0FBRyxNQUFNLEdBQUcsS0FBSyxDQUFDO0lBRXZDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsQ0FBQztBQUMzQyxDQUFDLENBQUM7QUFmVyxRQUFBLGlCQUFpQixxQkFlNUI7QUFFSyxNQUFNLG9CQUFvQixHQUFHLEdBQVMsRUFBRTtJQUM3QyxNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsZ0JBQWdCLENBQW1CLGVBQWUsQ0FBQyxDQUFDO0lBQzVFLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtRQUNyQixJQUFBLDBCQUFrQixFQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzFCLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDO0FBTFcsUUFBQSxvQkFBb0Isd0JBSy9CO0FBRUssTUFBTSxlQUFlLEdBQUcsR0FBUyxFQUFFO0lBQ3hDLE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBbUIsZUFBZSxDQUFDLENBQUM7SUFDNUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1FBQ3JCLElBQUEsMEJBQWtCLEVBQUMsR0FBRyxDQUFDLENBQUM7UUFDeEIsR0FBRyxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUM7UUFDYixHQUFHLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ2xDLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDO0FBUFcsUUFBQSxlQUFlLG1CQU8xQjtBQUVGLGtCQUFlO0lBQ2Isa0JBQWtCLEVBQWxCLDBCQUFrQjtJQUNsQixrQkFBa0IsRUFBbEIsMEJBQWtCO0lBQ2xCLGdCQUFnQixFQUFoQix3QkFBZ0I7SUFDaEIsa0JBQWtCLEVBQWxCLDBCQUFrQjtJQUNsQixvQkFBb0IsRUFBcEIsNEJBQW9CO0lBQ3BCLFNBQVMsRUFBVCxpQkFBUztJQUNULGNBQWMsRUFBZCxzQkFBYztJQUNkLGdCQUFnQixFQUFoQix3QkFBZ0I7SUFDaEIsMEJBQTBCLEVBQTFCLGtDQUEwQjtJQUMxQiw0QkFBNEIsRUFBNUIsb0NBQTRCO0lBQzVCLDhCQUE4QixFQUE5QixzQ0FBOEI7SUFDOUIsaUJBQWlCLEVBQWpCLHlCQUFpQjtJQUNqQixvQkFBb0IsRUFBcEIsNEJBQW9CO0lBQ3BCLGVBQWUsRUFBZix1QkFBZTtDQUNoQixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy95YW55dS9Eb3dubG9hZHMveXljMy1EZXNpZ24tU3lzdGVtL3NyYy91dGlscy9pbWFnZS1sYXp5LWxvYWRlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBmaWxlIOWbvueJh+aHkuWKoOi9veW3peWFt1xuICogQGRlc2NyaXB0aW9uIOaPkOS+m+WfuuS6jiBJbnRlcnNlY3Rpb25PYnNlcnZlciDnmoTlm77niYfmh5LliqDovb3lip/og71cbiAqIEBtb2R1bGUgdXRpbHMvaW1hZ2UtbGF6eS1sb2FkZXJcbiAqIEBhdXRob3IgWVlDwrNcbiAqIEB2ZXJzaW9uIDEuMC4wXG4gKiBAY3JlYXRlZCAyMDI2LTAyLTIyXG4gKi9cblxuZXhwb3J0IGludGVyZmFjZSBMYXp5SW1hZ2VPcHRpb25zIHtcbiAgcm9vdE1hcmdpbj86IHN0cmluZztcbiAgdGhyZXNob2xkPzogbnVtYmVyIHwgbnVtYmVyW107XG4gIHBsYWNlaG9sZGVyPzogc3RyaW5nO1xuICBlcnJvclBsYWNlaG9sZGVyPzogc3RyaW5nO1xuICByZXRyeUNvdW50PzogbnVtYmVyO1xuICByZXRyeURlbGF5PzogbnVtYmVyO1xuICBvbkxvYWQ/OiAoaW1nOiBIVE1MSW1hZ2VFbGVtZW50KSA9PiB2b2lkO1xuICBvbkVycm9yPzogKGltZzogSFRNTEltYWdlRWxlbWVudCkgPT4gdm9pZDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBMYXp5SW1hZ2VDb25maWcge1xuICBlbmFibGVkOiBib29sZWFuO1xuICByb290TWFyZ2luOiBzdHJpbmc7XG4gIHRocmVzaG9sZDogbnVtYmVyO1xuICBwbGFjZWhvbGRlcjogc3RyaW5nO1xuICBlcnJvclBsYWNlaG9sZGVyOiBzdHJpbmc7XG4gIHJldHJ5Q291bnQ6IG51bWJlcjtcbiAgcmV0cnlEZWxheTogbnVtYmVyO1xufVxuXG5jb25zdCBkZWZhdWx0Q29uZmlnOiBMYXp5SW1hZ2VDb25maWcgPSB7XG4gIGVuYWJsZWQ6IHRydWUsXG4gIHJvb3RNYXJnaW46ICc1MHB4JyxcbiAgdGhyZXNob2xkOiAwLjAxLFxuICBwbGFjZWhvbGRlcjpcbiAgICAnZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRBd0lpQm9aV2xuYUhROUlqRXdNQ0lnZUcxc2JuTTlJbWgwZEhBNkx5OTNkM2N1ZHpNdWIzSm5Mekl3TURBdmMzWm5JajQ4Y21WamRDQjNhV1IwYUQwaU1UQXdKU0lnYUdWcFoyaDBQU0l4TURBbElpQm1hV3hzUFNJalpqQm1NR1l3SWk4K1BDOXpkbWMrJyxcbiAgZXJyb3JQbGFjZWhvbGRlcjpcbiAgICAnZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRBd0lpQm9aV2xuYUhROUlqRXdNQ0lnZUcxc2JuTTlJbWgwZEhBNkx5OTNkM2N1ZHpNdWIzSm5Mekl3TURBdmMzWm5JajQ4Y21WamRDQjNhV1IwYUQwaU1UQXdKU0lnYUdWcFoyaDBQU0l4TURBbElpQm1hV3hzUFNJalptWmpaR05rSWk4K1BIUmxlSFFnZUQwaU5UQWxJaUI1UFNJMU1DVWlJR1J2YldsdVlXNTBMV0poYzJWc2FXNWxQU0p0YVdSa2JHVWlJSFJsZUhRdFlXNWphRzl5UFNKdGFXUmtiR1VpSUdacGJHdzlJaU01T1RrNU9Ua2lJR1p2Ym5RdGMybDZaVDBpTVRRaVB1YVhvRHd2ZEdWNGRENDhMM04yWno0PScsXG4gIHJldHJ5Q291bnQ6IDMsXG4gIHJldHJ5RGVsYXk6IDEwMDAsXG59O1xuXG5sZXQgZ2xvYmFsQ29uZmlnOiBMYXp5SW1hZ2VDb25maWcgPSB7IC4uLmRlZmF1bHRDb25maWcgfTtcblxuY29uc3Qgb2JzZXJ2ZXJNYXAgPSBuZXcgV2Vha01hcDxFbGVtZW50LCBJbnRlcnNlY3Rpb25PYnNlcnZlcj4oKTtcblxuZXhwb3J0IGNvbnN0IHNldExhenlJbWFnZUNvbmZpZyA9IChjb25maWc6IFBhcnRpYWw8TGF6eUltYWdlQ29uZmlnPik6IHZvaWQgPT4ge1xuICBnbG9iYWxDb25maWcgPSB7IC4uLmdsb2JhbENvbmZpZywgLi4uY29uZmlnIH07XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0TGF6eUltYWdlQ29uZmlnID0gKCk6IExhenlJbWFnZUNvbmZpZyA9PiB7XG4gIHJldHVybiB7IC4uLmdsb2JhbENvbmZpZyB9O1xufTtcblxuZXhwb3J0IGNvbnN0IGNyZWF0ZUxhenlJbWFnZU9ic2VydmVyID0gKFxuICBjYWxsYmFjazogSW50ZXJzZWN0aW9uT2JzZXJ2ZXJDYWxsYmFjayxcbiAgb3B0aW9ucz86IEludGVyc2VjdGlvbk9ic2VydmVySW5pdFxuKTogSW50ZXJzZWN0aW9uT2JzZXJ2ZXIgPT4ge1xuICBjb25zdCBkZWZhdWx0T3B0aW9uczogSW50ZXJzZWN0aW9uT2JzZXJ2ZXJJbml0ID0ge1xuICAgIHJvb3RNYXJnaW46IGdsb2JhbENvbmZpZy5yb290TWFyZ2luLFxuICAgIHRocmVzaG9sZDogZ2xvYmFsQ29uZmlnLnRocmVzaG9sZCxcbiAgfTtcblxuICByZXR1cm4gbmV3IEludGVyc2VjdGlvbk9ic2VydmVyKGNhbGxiYWNrLCB7IC4uLmRlZmF1bHRPcHRpb25zLCAuLi5vcHRpb25zIH0pO1xufTtcblxuZXhwb3J0IGNvbnN0IG9ic2VydmVMYXp5SW1hZ2UgPSAoXG4gIGVsZW1lbnQ6IEhUTUxJbWFnZUVsZW1lbnQsXG4gIG9wdGlvbnM/OiBMYXp5SW1hZ2VPcHRpb25zXG4pOiAoKCkgPT4gdm9pZCkgPT4ge1xuICBpZiAoIWdsb2JhbENvbmZpZy5lbmFibGVkIHx8ICEoJ0ludGVyc2VjdGlvbk9ic2VydmVyJyBpbiB3aW5kb3cpKSB7XG4gICAgbG9hZEltYWdlKGVsZW1lbnQsIG9wdGlvbnMpO1xuICAgIHJldHVybiAoKSA9PiB7fTtcbiAgfVxuXG4gIGNvbnN0IGRhdGFTcmMgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS1zcmMnKTtcbiAgaWYgKCFkYXRhU3JjKSB7XG4gICAgcmV0dXJuICgpID0+IHt9O1xuICB9XG5cbiAgY29uc3Qgb2JzZXJ2ZXIgPSBjcmVhdGVMYXp5SW1hZ2VPYnNlcnZlcigoZW50cmllcykgPT4ge1xuICAgIGVudHJpZXMuZm9yRWFjaCgoZW50cnkpID0+IHtcbiAgICAgIGlmIChlbnRyeS5pc0ludGVyc2VjdGluZykge1xuICAgICAgICBsb2FkSW1hZ2UoZW50cnkudGFyZ2V0IGFzIEhUTUxJbWFnZUVsZW1lbnQsIG9wdGlvbnMpO1xuICAgICAgICBvYnNlcnZlci51bm9ic2VydmUoZW50cnkudGFyZ2V0KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG5cbiAgb2JzZXJ2ZXIub2JzZXJ2ZShlbGVtZW50KTtcbiAgb2JzZXJ2ZXJNYXAuc2V0KGVsZW1lbnQsIG9ic2VydmVyKTtcblxuICByZXR1cm4gKCkgPT4ge1xuICAgIG9ic2VydmVyLnVub2JzZXJ2ZShlbGVtZW50KTtcbiAgICBvYnNlcnZlck1hcC5kZWxldGUoZWxlbWVudCk7XG4gIH07XG59O1xuXG5leHBvcnQgY29uc3QgbG9hZEltYWdlID0gKFxuICBlbGVtZW50OiBIVE1MSW1hZ2VFbGVtZW50LFxuICBvcHRpb25zPzogTGF6eUltYWdlT3B0aW9ucyxcbiAgcmV0cnlDb3VudDogbnVtYmVyID0gMFxuKTogdm9pZCA9PiB7XG4gIGNvbnN0IGRhdGFTcmMgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS1zcmMnKTtcbiAgaWYgKCFkYXRhU3JjKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3Qge1xuICAgIHBsYWNlaG9sZGVyID0gZ2xvYmFsQ29uZmlnLnBsYWNlaG9sZGVyLFxuICAgIGVycm9yUGxhY2Vob2xkZXIgPSBnbG9iYWxDb25maWcuZXJyb3JQbGFjZWhvbGRlcixcbiAgICByZXRyeUNvdW50OiBtYXhSZXRyaWVzID0gZ2xvYmFsQ29uZmlnLnJldHJ5Q291bnQsXG4gICAgcmV0cnlEZWxheSA9IGdsb2JhbENvbmZpZy5yZXRyeURlbGF5LFxuICAgIG9uTG9hZCxcbiAgICBvbkVycm9yLFxuICB9ID0gb3B0aW9ucyB8fCB7fTtcblxuICBjb25zdCBvcmlnaW5hbFNyYyA9IGVsZW1lbnQuc3JjO1xuICBlbGVtZW50LnNyYyA9IHBsYWNlaG9sZGVyO1xuXG4gIGNvbnN0IGltZyA9IG5ldyBJbWFnZSgpO1xuXG4gIGltZy5vbmxvYWQgPSAoKSA9PiB7XG4gICAgZWxlbWVudC5zcmMgPSBkYXRhU3JjO1xuICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCdkYXRhLXNyYycpO1xuICAgIGVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnbGF6eS1sb2FkZWQnKTtcbiAgICBvbkxvYWQ/LihlbGVtZW50KTtcbiAgfTtcblxuICBpbWcub25lcnJvciA9ICgpID0+IHtcbiAgICBpZiAocmV0cnlDb3VudCA8IG1heFJldHJpZXMpIHtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBsb2FkSW1hZ2UoZWxlbWVudCwgb3B0aW9ucywgcmV0cnlDb3VudCArIDEpO1xuICAgICAgfSwgcmV0cnlEZWxheSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGVsZW1lbnQuc3JjID0gZXJyb3JQbGFjZWhvbGRlcjtcbiAgICAgIGVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnbGF6eS1lcnJvcicpO1xuICAgICAgb25FcnJvcj8uKGVsZW1lbnQpO1xuICAgIH1cbiAgfTtcblxuICBpbWcuc3JjID0gZGF0YVNyYztcbn07XG5cbmV4cG9ydCBjb25zdCB1bm9ic2VydmVMYXp5SW1hZ2UgPSAoZWxlbWVudDogSFRNTEltYWdlRWxlbWVudCk6IHZvaWQgPT4ge1xuICBjb25zdCBvYnNlcnZlciA9IG9ic2VydmVyTWFwLmdldChlbGVtZW50KTtcbiAgaWYgKG9ic2VydmVyKSB7XG4gICAgb2JzZXJ2ZXIudW5vYnNlcnZlKGVsZW1lbnQpO1xuICAgIG9ic2VydmVyTWFwLmRlbGV0ZShlbGVtZW50KTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IG9ic2VydmVBbGxMYXp5SW1hZ2VzID0gKFxuICBzZWxlY3Rvcjogc3RyaW5nID0gJ2ltZ1tkYXRhLXNyY10nLFxuICBvcHRpb25zPzogTGF6eUltYWdlT3B0aW9uc1xuKTogKCgpID0+IHZvaWQpID0+IHtcbiAgY29uc3QgaW1hZ2VzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbDxIVE1MSW1hZ2VFbGVtZW50PihzZWxlY3Rvcik7XG4gIGNvbnN0IHVub2JzZXJ2ZUZ1bmN0aW9uczogQXJyYXk8KCkgPT4gdm9pZD4gPSBbXTtcblxuICBpbWFnZXMuZm9yRWFjaCgoaW1nKSA9PiB7XG4gICAgdW5vYnNlcnZlRnVuY3Rpb25zLnB1c2gob2JzZXJ2ZUxhenlJbWFnZShpbWcsIG9wdGlvbnMpKTtcbiAgfSk7XG5cbiAgcmV0dXJuICgpID0+IHtcbiAgICB1bm9ic2VydmVGdW5jdGlvbnMuZm9yRWFjaCgodW5vYnNlcnZlKSA9PiB1bm9ic2VydmUoKSk7XG4gIH07XG59O1xuXG5leHBvcnQgY29uc3QgcmVzZXRMYXp5SW1hZ2UgPSAoZWxlbWVudDogSFRNTEltYWdlRWxlbWVudCwgb3JpZ2luYWxTcmM6IHN0cmluZyk6IHZvaWQgPT4ge1xuICBlbGVtZW50LnNyYyA9IGdsb2JhbENvbmZpZy5wbGFjZWhvbGRlcjtcbiAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2RhdGEtc3JjJywgb3JpZ2luYWxTcmMpO1xuICBlbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoJ2xhenktbG9hZGVkJywgJ2xhenktZXJyb3InKTtcbiAgdW5vYnNlcnZlTGF6eUltYWdlKGVsZW1lbnQpO1xufTtcblxuZXhwb3J0IGNvbnN0IHByZWxvYWRMYXp5SW1hZ2UgPSAoXG4gIHNyYzogc3RyaW5nLFxuICBvcHRpb25zPzogTGF6eUltYWdlT3B0aW9uc1xuKTogUHJvbWlzZTxIVE1MSW1hZ2VFbGVtZW50PiA9PiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgY29uc3QgaW1nID0gbmV3IEltYWdlKCk7XG5cbiAgICBpbWcub25sb2FkID0gKCkgPT4ge1xuICAgICAgb3B0aW9ucz8ub25Mb2FkPy4oaW1nKTtcbiAgICAgIHJlc29sdmUoaW1nKTtcbiAgICB9O1xuXG4gICAgaW1nLm9uZXJyb3IgPSAoKSA9PiB7XG4gICAgICBvcHRpb25zPy5vbkVycm9yPy4oaW1nKTtcbiAgICAgIHJlamVjdChuZXcgRXJyb3IoYEZhaWxlZCB0byBsb2FkIGltYWdlOiAke3NyY31gKSk7XG4gICAgfTtcblxuICAgIGltZy5zcmMgPSBzcmM7XG4gIH0pO1xufTtcblxuZXhwb3J0IGNvbnN0IGNyZWF0ZUxhenlJbWFnZUJhdGNoTG9hZGVyID0gKGJhdGNoU2l6ZTogbnVtYmVyID0gNSwgZGVsYXk6IG51bWJlciA9IDEwMCkgPT4ge1xuICBsZXQgcXVldWU6IEhUTUxJbWFnZUVsZW1lbnRbXSA9IFtdO1xuICBsZXQgcHJvY2Vzc2luZyA9IGZhbHNlO1xuXG4gIGNvbnN0IHByb2Nlc3NCYXRjaCA9IGFzeW5jICgpID0+IHtcbiAgICBpZiAocHJvY2Vzc2luZyB8fCBxdWV1ZS5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBwcm9jZXNzaW5nID0gdHJ1ZTtcbiAgICBjb25zdCBiYXRjaCA9IHF1ZXVlLnNwbGljZSgwLCBiYXRjaFNpemUpO1xuXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICBiYXRjaC5tYXAoKGltZykgPT4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUpID0+IHtcbiAgICAgICAgICBjb25zdCBkYXRhU3JjID0gaW1nLmdldEF0dHJpYnV0ZSgnZGF0YS1zcmMnKTtcbiAgICAgICAgICBpZiAoZGF0YVNyYykge1xuICAgICAgICAgICAgY29uc3QgdGVtcEltZyA9IG5ldyBJbWFnZSgpO1xuICAgICAgICAgICAgdGVtcEltZy5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgICAgICAgIGltZy5zcmMgPSBkYXRhU3JjO1xuICAgICAgICAgICAgICBpbWcucmVtb3ZlQXR0cmlidXRlKCdkYXRhLXNyYycpO1xuICAgICAgICAgICAgICBpbWcuY2xhc3NMaXN0LmFkZCgnbGF6eS1sb2FkZWQnKTtcbiAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRlbXBJbWcub25lcnJvciA9ICgpID0+IHtcbiAgICAgICAgICAgICAgaW1nLnNyYyA9IGdsb2JhbENvbmZpZy5lcnJvclBsYWNlaG9sZGVyO1xuICAgICAgICAgICAgICBpbWcuY2xhc3NMaXN0LmFkZCgnbGF6eS1lcnJvcicpO1xuICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGVtcEltZy5zcmMgPSBkYXRhU3JjO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHByb2Nlc3NpbmcgPSBmYWxzZTtcblxuICAgIGlmIChxdWV1ZS5sZW5ndGggPiAwKSB7XG4gICAgICBzZXRUaW1lb3V0KHByb2Nlc3NCYXRjaCwgZGVsYXkpO1xuICAgIH1cbiAgfTtcblxuICByZXR1cm4ge1xuICAgIGFkZDogKGltZzogSFRNTEltYWdlRWxlbWVudCkgPT4ge1xuICAgICAgcXVldWUucHVzaChpbWcpO1xuICAgICAgcHJvY2Vzc0JhdGNoKCk7XG4gICAgfSxcbiAgICBhZGRCYXRjaDogKGltYWdlczogSFRNTEltYWdlRWxlbWVudFtdKSA9PiB7XG4gICAgICBxdWV1ZS5wdXNoKC4uLmltYWdlcyk7XG4gICAgICBwcm9jZXNzQmF0Y2goKTtcbiAgICB9LFxuICAgIGNsZWFyOiAoKSA9PiB7XG4gICAgICBxdWV1ZSA9IFtdO1xuICAgIH0sXG4gICAgZ2V0UXVldWVTaXplOiAoKSA9PiBxdWV1ZS5sZW5ndGgsXG4gIH07XG59O1xuXG5leHBvcnQgY29uc3QgY3JlYXRlUHJvZ3Jlc3NpdmVJbWFnZUxvYWRlciA9IChcbiAgbG93UXVhbGl0eVNyYzogc3RyaW5nLFxuICBoaWdoUXVhbGl0eVNyYzogc3RyaW5nLFxuICBlbGVtZW50OiBIVE1MSW1hZ2VFbGVtZW50LFxuICBvcHRpb25zPzogTGF6eUltYWdlT3B0aW9uc1xuKTogdm9pZCA9PiB7XG4gIGVsZW1lbnQuc3JjID0gbG93UXVhbGl0eVNyYztcbiAgZWxlbWVudC5jbGFzc0xpc3QuYWRkKCdwcm9ncmVzc2l2ZS1sb2FkaW5nJyk7XG5cbiAgY29uc3QgaGlnaFF1YWxpdHlJbWcgPSBuZXcgSW1hZ2UoKTtcblxuICBoaWdoUXVhbGl0eUltZy5vbmxvYWQgPSAoKSA9PiB7XG4gICAgZWxlbWVudC5zcmMgPSBoaWdoUXVhbGl0eVNyYztcbiAgICBlbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoJ3Byb2dyZXNzaXZlLWxvYWRpbmcnKTtcbiAgICBlbGVtZW50LmNsYXNzTGlzdC5hZGQoJ3Byb2dyZXNzaXZlLWxvYWRlZCcpO1xuICAgIG9wdGlvbnM/Lm9uTG9hZD8uKGVsZW1lbnQpO1xuICB9O1xuXG4gIGhpZ2hRdWFsaXR5SW1nLm9uZXJyb3IgPSAoKSA9PiB7XG4gICAgZWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKCdwcm9ncmVzc2l2ZS1sb2FkaW5nJyk7XG4gICAgZWxlbWVudC5jbGFzc0xpc3QuYWRkKCdwcm9ncmVzc2l2ZS1lcnJvcicpO1xuICAgIG9wdGlvbnM/Lm9uRXJyb3I/LihlbGVtZW50KTtcbiAgfTtcblxuICBoaWdoUXVhbGl0eUltZy5zcmMgPSBoaWdoUXVhbGl0eVNyYztcbn07XG5cbmV4cG9ydCBjb25zdCBjcmVhdGVMYXp5SW1hZ2VXaXRoUGxhY2Vob2xkZXIgPSAoXG4gIGVsZW1lbnQ6IEhUTUxJbWFnZUVsZW1lbnQsXG4gIHBsYWNlaG9sZGVyQ29sb3I6IHN0cmluZyA9ICcjZjBmMGYwJyxcbiAgcGxhY2Vob2xkZXJUZXh0OiBzdHJpbmcgPSAnTG9hZGluZy4uLidcbik6IHZvaWQgPT4ge1xuICBjb25zdCBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgY2FudmFzLndpZHRoID0gMTAwO1xuICBjYW52YXMuaGVpZ2h0ID0gMTAwO1xuICBjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcblxuICBpZiAoY3R4KSB7XG4gICAgY3R4LmZpbGxTdHlsZSA9IHBsYWNlaG9sZGVyQ29sb3I7XG4gICAgY3R4LmZpbGxSZWN0KDAsIDAsIDEwMCwgMTAwKTtcblxuICAgIGN0eC5maWxsU3R5bGUgPSAnIzk5OSc7XG4gICAgY3R4LmZvbnQgPSAnMTRweCBBcmlhbCc7XG4gICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInO1xuICAgIGN0eC50ZXh0QmFzZWxpbmUgPSAnbWlkZGxlJztcbiAgICBjdHguZmlsbFRleHQocGxhY2Vob2xkZXJUZXh0LCA1MCwgNTApO1xuXG4gICAgZWxlbWVudC5zcmMgPSBjYW52YXMudG9EYXRhVVJMKCdpbWFnZS9wbmcnKTtcbiAgfVxuXG4gIG9ic2VydmVMYXp5SW1hZ2UoZWxlbWVudCk7XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0TGF6eUltYWdlU3RhdHMgPSAoKToge1xuICB0b3RhbDogbnVtYmVyO1xuICBsb2FkZWQ6IG51bWJlcjtcbiAgZXJyb3I6IG51bWJlcjtcbiAgcGVuZGluZzogbnVtYmVyO1xufSA9PiB7XG4gIGNvbnN0IGltYWdlcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGw8SFRNTEltYWdlRWxlbWVudD4oXG4gICAgJ2ltZ1tkYXRhLXNyY10sIGltZy5sYXp5LWxvYWRlZCwgaW1nLmxhenktZXJyb3InXG4gICk7XG4gIGNvbnN0IHRvdGFsID0gaW1hZ2VzLmxlbmd0aDtcbiAgY29uc3QgbG9hZGVkID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbDxIVE1MSW1hZ2VFbGVtZW50PignaW1nLmxhenktbG9hZGVkJykubGVuZ3RoO1xuICBjb25zdCBlcnJvciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGw8SFRNTEltYWdlRWxlbWVudD4oJ2ltZy5sYXp5LWVycm9yJykubGVuZ3RoO1xuICBjb25zdCBwZW5kaW5nID0gdG90YWwgLSBsb2FkZWQgLSBlcnJvcjtcblxuICByZXR1cm4geyB0b3RhbCwgbG9hZGVkLCBlcnJvciwgcGVuZGluZyB9O1xufTtcblxuZXhwb3J0IGNvbnN0IGRlc3Ryb3lBbGxMYXp5SW1hZ2VzID0gKCk6IHZvaWQgPT4ge1xuICBjb25zdCBpbWFnZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsPEhUTUxJbWFnZUVsZW1lbnQ+KCdpbWdbZGF0YS1zcmNdJyk7XG4gIGltYWdlcy5mb3JFYWNoKChpbWcpID0+IHtcbiAgICB1bm9ic2VydmVMYXp5SW1hZ2UoaW1nKTtcbiAgfSk7XG59O1xuXG5leHBvcnQgY29uc3QgY2xlYXJJbWFnZUNhY2hlID0gKCk6IHZvaWQgPT4ge1xuICBjb25zdCBpbWFnZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsPEhUTUxJbWFnZUVsZW1lbnQ+KCdpbWdbZGF0YS1zcmNdJyk7XG4gIGltYWdlcy5mb3JFYWNoKChpbWcpID0+IHtcbiAgICB1bm9ic2VydmVMYXp5SW1hZ2UoaW1nKTtcbiAgICBpbWcuc3JjID0gJyc7XG4gICAgaW1nLnJlbW92ZUF0dHJpYnV0ZSgnZGF0YS1zcmMnKTtcbiAgfSk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCB7XG4gIHNldExhenlJbWFnZUNvbmZpZyxcbiAgZ2V0TGF6eUltYWdlQ29uZmlnLFxuICBvYnNlcnZlTGF6eUltYWdlLFxuICB1bm9ic2VydmVMYXp5SW1hZ2UsXG4gIG9ic2VydmVBbGxMYXp5SW1hZ2VzLFxuICBsb2FkSW1hZ2UsXG4gIHJlc2V0TGF6eUltYWdlLFxuICBwcmVsb2FkTGF6eUltYWdlLFxuICBjcmVhdGVMYXp5SW1hZ2VCYXRjaExvYWRlcixcbiAgY3JlYXRlUHJvZ3Jlc3NpdmVJbWFnZUxvYWRlcixcbiAgY3JlYXRlTGF6eUltYWdlV2l0aFBsYWNlaG9sZGVyLFxuICBnZXRMYXp5SW1hZ2VTdGF0cyxcbiAgZGVzdHJveUFsbExhenlJbWFnZXMsXG4gIGNsZWFySW1hZ2VDYWNoZSxcbn07XG4iXSwidmVyc2lvbiI6M30=