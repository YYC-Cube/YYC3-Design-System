7c345a44ca4f7ee2580f0a1d4c42e12a
"use strict";
/**
 * @file 主题持久化工具
 * @description YYC³ 设计系统主题持久化工具，提供localStorage主题存储和管理
 * @module utils/theme-persistence
 * @author YYC³
 * @version 1.0.0
 * @created 2026-02-21
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.isThemePersisted = exports.getThemeInfo = exports.initThemePersistence = exports.syncThemeWithSystem = exports.migrateTheme = exports.clearStoredTheme = exports.setStoredTheme = exports.getStoredTheme = exports.getSystemTheme = void 0;
const THEME_KEY = 'yyc3-theme';
const THEME_VERSION_KEY = 'yyc3-theme-version';
const CURRENT_THEME_VERSION = '1.0.0';
const getSystemTheme = () => {
    if (typeof window === 'undefined')
        return 'light';
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    return mediaQuery.matches ? 'dark' : 'light';
};
exports.getSystemTheme = getSystemTheme;
const getStoredTheme = () => {
    if (typeof window === 'undefined')
        return 'light';
    try {
        const stored = localStorage.getItem(THEME_KEY);
        if (stored) {
            const config = JSON.parse(stored);
            if (config.version !== CURRENT_THEME_VERSION) {
                (0, exports.migrateTheme)(config.version);
                return 'light';
            }
            if (config.mode === 'system') {
                return (0, exports.getSystemTheme)();
            }
            return config.mode;
        }
    }
    catch (e) {
        console.warn('Failed to read theme from localStorage:', e);
    }
    return 'light';
};
exports.getStoredTheme = getStoredTheme;
const setStoredTheme = (mode) => {
    if (typeof window === 'undefined')
        return;
    try {
        const config = {
            mode,
            version: CURRENT_THEME_VERSION,
            timestamp: Date.now(),
        };
        localStorage.setItem(THEME_KEY, JSON.stringify(config));
        localStorage.setItem(THEME_VERSION_KEY, CURRENT_THEME_VERSION);
        document.documentElement.setAttribute('data-theme', mode);
        if (mode === 'system') {
            const systemTheme = (0, exports.getSystemTheme)();
            document.documentElement.setAttribute('data-theme', systemTheme);
        }
    }
    catch (e) {
        console.warn('Failed to save theme to localStorage:', e);
    }
};
exports.setStoredTheme = setStoredTheme;
const clearStoredTheme = () => {
    if (typeof window === 'undefined')
        return;
    try {
        localStorage.removeItem(THEME_KEY);
        localStorage.removeItem(THEME_VERSION_KEY);
        document.documentElement.removeAttribute('data-theme');
    }
    catch (e) {
        console.warn('Failed to clear theme from localStorage:', e);
    }
};
exports.clearStoredTheme = clearStoredTheme;
const migrateTheme = (fromVersion) => {
    console.warn(`Migrating theme from version ${fromVersion} to ${CURRENT_THEME_VERSION}`);
    try {
        const stored = localStorage.getItem(THEME_KEY);
        if (stored) {
            const config = JSON.parse(stored);
            config.version = CURRENT_THEME_VERSION;
            localStorage.setItem(THEME_KEY, JSON.stringify(config));
        }
    }
    catch (e) {
        console.warn('Failed to migrate theme:', e);
    }
};
exports.migrateTheme = migrateTheme;
const syncThemeWithSystem = () => {
    if (typeof window === 'undefined')
        return;
    const stored = localStorage.getItem(THEME_KEY);
    if (stored) {
        const config = JSON.parse(stored);
        if (config.mode === 'system') {
            const systemTheme = (0, exports.getSystemTheme)();
            document.documentElement.setAttribute('data-theme', systemTheme);
        }
    }
};
exports.syncThemeWithSystem = syncThemeWithSystem;
exports.initThemePersistence = (() => {
    if (typeof window === 'undefined')
        return () => { };
    const mode = (0, exports.getStoredTheme)();
    (0, exports.setStoredTheme)(mode);
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    const handleSystemThemeChange = (e) => {
        const stored = localStorage.getItem(THEME_KEY);
        if (stored) {
            const config = JSON.parse(stored);
            if (config.mode === 'system') {
                const newTheme = e.matches ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                window.dispatchEvent(new CustomEvent('theme-change', { detail: newTheme }));
            }
        }
    };
    mediaQuery.addEventListener('change', handleSystemThemeChange);
    return () => {
        mediaQuery.removeEventListener('change', handleSystemThemeChange);
    };
})();
const getThemeInfo = () => {
    if (typeof window === 'undefined')
        return null;
    try {
        const stored = localStorage.getItem(THEME_KEY);
        if (stored) {
            return JSON.parse(stored);
        }
    }
    catch (e) {
        console.warn('Failed to read theme info from localStorage:', e);
    }
    return null;
};
exports.getThemeInfo = getThemeInfo;
const isThemePersisted = () => {
    if (typeof window === 'undefined')
        return false;
    try {
        return localStorage.getItem(THEME_KEY) !== null;
    }
    catch {
        return false;
    }
};
exports.isThemePersisted = isThemePersisted;
exports.default = {
    getSystemTheme: exports.getSystemTheme,
    getStoredTheme: exports.getStoredTheme,
    setStoredTheme: exports.setStoredTheme,
    clearStoredTheme: exports.clearStoredTheme,
    migrateTheme: exports.migrateTheme,
    syncThemeWithSystem: exports.syncThemeWithSystem,
    initThemePersistence: exports.initThemePersistence,
    getThemeInfo: exports.getThemeInfo,
    isThemePersisted: exports.isThemePersisted,
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3lhbnl1L0Rvd25sb2Fkcy95eWMzLURlc2lnbi1TeXN0ZW0vc3JjL3V0aWxzL3RoZW1lLXBlcnNpc3RlbmNlLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7OztHQU9HOzs7QUFFSCxNQUFNLFNBQVMsR0FBRyxZQUFZLENBQUM7QUFDL0IsTUFBTSxpQkFBaUIsR0FBRyxvQkFBb0IsQ0FBQztBQUMvQyxNQUFNLHFCQUFxQixHQUFHLE9BQU8sQ0FBQztBQVUvQixNQUFNLGNBQWMsR0FBRyxHQUFjLEVBQUU7SUFDNUMsSUFBSSxPQUFPLE1BQU0sS0FBSyxXQUFXO1FBQUUsT0FBTyxPQUFPLENBQUM7SUFFbEQsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO0lBQ3JFLE9BQU8sVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7QUFDL0MsQ0FBQyxDQUFDO0FBTFcsUUFBQSxjQUFjLGtCQUt6QjtBQUVLLE1BQU0sY0FBYyxHQUFHLEdBQWMsRUFBRTtJQUM1QyxJQUFJLE9BQU8sTUFBTSxLQUFLLFdBQVc7UUFBRSxPQUFPLE9BQU8sQ0FBQztJQUVsRCxJQUFJLENBQUM7UUFDSCxNQUFNLE1BQU0sR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQy9DLElBQUksTUFBTSxFQUFFLENBQUM7WUFDWCxNQUFNLE1BQU0sR0FBZ0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUUvQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLEtBQUsscUJBQXFCLEVBQUUsQ0FBQztnQkFDN0MsSUFBQSxvQkFBWSxFQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFDN0IsT0FBTyxPQUFPLENBQUM7WUFDakIsQ0FBQztZQUVELElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxRQUFRLEVBQUUsQ0FBQztnQkFDN0IsT0FBTyxJQUFBLHNCQUFjLEdBQUUsQ0FB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WSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsS0FBSyxJQUFJLENBQUM7SUFDbEQsQ0FBQztJQUFDLE1BQU0sQ0FBQztRQUNQLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztBQUNILENBQUMsQ0FBQztBQVJXLFFBQUEsZ0JBQWdCLG9CQVEzQjtBQUVGLGtCQUFlO0lBQ2IsY0FBYyxFQUFkLHNCQUFjO0lBQ2QsY0FBYyxFQUFkLHNCQUFjO0lBQ2QsY0FBYyxFQUFkLHNCQUFjO0lBQ2QsZ0JBQWdCLEVBQWhCLHdCQUFnQjtJQUNoQixZQUFZLEVBQVosb0JBQVk7SUFDWixtQkFBbUIsRUFBbkIsMkJBQW1CO0lBQ25CLG9CQUFvQixFQUFwQiw0QkFBb0I7SUFDcEIsWUFBWSxFQUFaLG9CQUFZO0lBQ1osZ0JBQWdCLEVBQWhCLHdCQUFnQjtDQUNqQixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy95YW55dS9Eb3dubG9hZHMveXljMy1EZXNpZ24tU3lzdGVtL3NyYy91dGlscy90aGVtZS1wZXJzaXN0ZW5jZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBmaWxlIOS4u+mimOaMgeS5heWMluW3peWFt1xuICogQGRlc2NyaXB0aW9uIFlZQ8KzIOiuvuiuoeezu+e7n+S4u+mimOaMgeS5heWMluW3peWFt++8jOaPkOS+m2xvY2FsU3RvcmFnZeS4u+mimOWtmOWCqOWSjOeuoeeQhlxuICogQG1vZHVsZSB1dGlscy90aGVtZS1wZXJzaXN0ZW5jZVxuICogQGF1dGhvciBZWUPCs1xuICogQHZlcnNpb24gMS4wLjBcbiAqIEBjcmVhdGVkIDIwMjYtMDItMjFcbiAqL1xuXG5jb25zdCBUSEVNRV9LRVkgPSAneXljMy10aGVtZSc7XG5jb25zdCBUSEVNRV9WRVJTSU9OX0tFWSA9ICd5eWMzLXRoZW1lLXZlcnNpb24nO1xuY29uc3QgQ1VSUkVOVF9USEVNRV9WRVJTSU9OID0gJzEuMC4wJztcblxuZXhwb3J0IHR5cGUgVGhlbWVNb2RlID0gJ2xpZ2h0JyB8ICdkYXJrJyB8ICdzeXN0ZW0nO1xuXG5leHBvcnQgaW50ZXJmYWNlIFRoZW1lQ29uZmlnIHtcbiAgbW9kZTogVGhlbWVNb2RlO1xuICB2ZXJzaW9uOiBzdHJpbmc7XG4gIHRpbWVzdGFtcDogbnVtYmVyO1xufVxuXG5leHBvcnQgY29uc3QgZ2V0U3lzdGVtVGhlbWUgPSAoKTogVGhlbWVNb2RlID0+IHtcbiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gJ2xpZ2h0JztcblxuICBjb25zdCBtZWRpYVF1ZXJ5ID0gd2luZG93Lm1hdGNoTWVkaWEoJyhwcmVmZXJzLWNvbG9yLXNjaGVtZTogZGFyayknKTtcbiAgcmV0dXJuIG1lZGlhUXVlcnkubWF0Y2hlcyA/ICdkYXJrJyA6ICdsaWdodCc7XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0U3RvcmVkVGhlbWUgPSAoKTogVGhlbWVNb2RlID0+IHtcbiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gJ2xpZ2h0JztcblxuICB0cnkge1xuICAgIGNvbnN0IHN0b3JlZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFRIRU1FX0tFWSk7XG4gICAgaWYgKHN0b3JlZCkge1xuICAgICAgY29uc3QgY29uZmlnOiBUaGVtZUNvbmZpZyA9IEpTT04ucGFyc2Uoc3RvcmVkKTtcblxuICAgICAgaWYgKGNvbmZpZy52ZXJzaW9uICE9PSBDVVJSRU5UX1RIRU1FX1ZFUlNJT04pIHtcbiAgICAgICAgbWlncmF0ZVRoZW1lKGNvbmZpZy52ZXJzaW9uKTtcbiAgICAgICAgcmV0dXJuICdsaWdodCc7XG4gICAgICB9XG5cbiAgICAgIGlmIChjb25maWcubW9kZSA9PT0gJ3N5c3RlbScpIHtcbiAgICAgICAgcmV0dXJuIGdldFN5c3RlbVRoZW1lKCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBjb25maWcubW9kZTtcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBjb25zb2xlLndhcm4oJ0ZhaWxlZCB0byByZWFkIHRoZW1lIGZyb20gbG9jYWxTdG9yYWdlOicsIGUpO1xuICB9XG5cbiAgcmV0dXJuICdsaWdodCc7XG59O1xuXG5leHBvcnQgY29uc3Qgc2V0U3RvcmVkVGhlbWUgPSAobW9kZTogVGhlbWVNb2RlKTogdm9pZCA9PiB7XG4gIGlmICh0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJykgcmV0dXJuO1xuXG4gIHRyeSB7XG4gICAgY29uc3QgY29uZmlnOiBUaGVtZUNvbmZpZyA9IHtcbiAgICAgIG1vZGUsXG4gICAgICB2ZXJzaW9uOiBDVVJSRU5UX1RIRU1FX1ZFUlNJT04sXG4gICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgfTtcblxuICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFRIRU1FX0tFWSwgSlNPTi5zdHJpbmdpZnkoY29uZmlnKSk7XG4gICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oVEhFTUVfVkVSU0lPTl9LRVksIENVUlJFTlRfVEhFTUVfVkVSU0lPTik7XG5cbiAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2V0QXR0cmlidXRlKCdkYXRhLXRoZW1lJywgbW9kZSk7XG5cbiAgICBpZiAobW9kZSA9PT0gJ3N5c3RlbScpIHtcbiAgICAgIGNvbnN0IHN5c3RlbVRoZW1lID0gZ2V0U3lzdGVtVGhlbWUoKTtcbiAgICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2RhdGEtdGhlbWUnLCBzeXN0ZW1UaGVtZSk7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgY29uc29sZS53YXJuKCdGYWlsZWQgdG8gc2F2ZSB0aGVtZSB0byBsb2NhbFN0b3JhZ2U6JywgZSk7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBjbGVhclN0b3JlZFRoZW1lID0gKCk6IHZvaWQgPT4ge1xuICBpZiAodHlwZW9mIHdpbmRvdyA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjtcblxuICB0cnkge1xuICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKFRIRU1FX0tFWSk7XG4gICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oVEhFTUVfVkVSU0lPTl9LRVkpO1xuICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoJ2RhdGEtdGhlbWUnKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUud2FybignRmFpbGVkIHRvIGNsZWFyIHRoZW1lIGZyb20gbG9jYWxTdG9yYWdlOicsIGUpO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgbWlncmF0ZVRoZW1lID0gKGZyb21WZXJzaW9uOiBzdHJpbmcpOiB2b2lkID0+IHtcbiAgY29uc29sZS53YXJuKGBNaWdyYXRpbmcgdGhlbWUgZnJvbSB2ZXJzaW9uICR7ZnJvbVZlcnNpb259IHRvICR7Q1VSUkVOVF9USEVNRV9WRVJTSU9OfWApO1xuXG4gIHRyeSB7XG4gICAgY29uc3Qgc3RvcmVkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oVEhFTUVfS0VZKTtcbiAgICBpZiAoc3RvcmVkKSB7XG4gICAgICBjb25zdCBjb25maWc6IFRoZW1lQ29uZmlnID0gSlNPTi5wYXJzZShzdG9yZWQpO1xuICAgICAgY29uZmlnLnZlcnNpb24gPSBDVVJSRU5UX1RIRU1FX1ZFUlNJT047XG4gICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShUSEVNRV9LRVksIEpTT04uc3RyaW5naWZ5KGNvbmZpZykpO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUud2FybignRmFpbGVkIHRvIG1pZ3JhdGUgdGhlbWU6JywgZSk7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBzeW5jVGhlbWVXaXRoU3lzdGVtID0gKCk6IHZvaWQgPT4ge1xuICBpZiAodHlwZW9mIHdpbmRvdyA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjtcblxuICBjb25zdCBzdG9yZWQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShUSEVNRV9LRVkpO1xuICBpZiAoc3RvcmVkKSB7XG4gICAgY29uc3QgY29uZmlnOiBUaGVtZUNvbmZpZyA9IEpTT04ucGFyc2Uoc3RvcmVkKTtcbiAgICBpZiAoY29uZmlnLm1vZGUgPT09ICdzeXN0ZW0nKSB7XG4gICAgICBjb25zdCBzeXN0ZW1UaGVtZSA9IGdldFN5c3RlbVRoZW1lKCk7XG4gICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2V0QXR0cmlidXRlKCdkYXRhLXRoZW1lJywgc3lzdGVtVGhlbWUpO1xuICAgIH1cbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IGluaXRUaGVtZVBlcnNpc3RlbmNlID0gKCgpID0+IHtcbiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gKCkgPT4ge307XG5cbiAgY29uc3QgbW9kZSA9IGdldFN0b3JlZFRoZW1lKCk7XG4gIHNldFN0b3JlZFRoZW1lKG1vZGUpO1xuXG4gIGNvbnN0IG1lZGlhUXVlcnkgPSB3aW5kb3cubWF0Y2hNZWRpYSgnKHByZWZlcnMtY29sb3Itc2NoZW1lOiBkYXJrKScpO1xuXG4gIGNvbnN0IGhhbmRsZVN5c3RlbVRoZW1lQ2hhbmdlID0gKGU6IE1lZGlhUXVlcnlMaXN0RXZlbnQpOiB2b2lkID0+IHtcbiAgICBjb25zdCBzdG9yZWQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShUSEVNRV9LRVkpO1xuICAgIGlmIChzdG9yZWQpIHtcbiAgICAgIGNvbnN0IGNvbmZpZzogVGhlbWVDb25maWcgPSBKU09OLnBhcnNlKHN0b3JlZCk7XG4gICAgICBpZiAoY29uZmlnLm1vZGUgPT09ICdzeXN0ZW0nKSB7XG4gICAgICAgIGNvbnN0IG5ld1RoZW1lID0gZS5tYXRjaGVzID8gJ2RhcmsnIDogJ2xpZ2h0JztcbiAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNldEF0dHJpYnV0ZSgnZGF0YS10aGVtZScsIG5ld1RoZW1lKTtcbiAgICAgICAgd2luZG93LmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCd0aGVtZS1jaGFuZ2UnLCB7IGRldGFpbDogbmV3VGhlbWUgfSkpO1xuICAgICAgfVxuICAgIH1cbiAgfTtcblxuICBtZWRpYVF1ZXJ5LmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIGhhbmRsZVN5c3RlbVRoZW1lQ2hhbmdlKTtcblxuICByZXR1cm4gKCkgPT4ge1xuICAgIG1lZGlhUXVlcnkucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgaGFuZGxlU3lzdGVtVGhlbWVDaGFuZ2UpO1xuICB9O1xufSkoKTtcblxuZXhwb3J0IGNvbnN0IGdldFRoZW1lSW5mbyA9ICgpOiBUaGVtZUNvbmZpZyB8IG51bGwgPT4ge1xuICBpZiAodHlwZW9mIHdpbmRvdyA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBudWxsO1xuXG4gIHRyeSB7XG4gICAgY29uc3Qgc3RvcmVkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oVEhFTUVfS0VZKTtcbiAgICBpZiAoc3RvcmVkKSB7XG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShzdG9yZWQpO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUud2FybignRmFpbGVkIHRvIHJlYWQgdGhlbWUgaW5mbyBmcm9tIGxvY2FsU3RvcmFnZTonLCBlKTtcbiAgfVxuXG4gIHJldHVybiBudWxsO1xufTtcblxuZXhwb3J0IGNvbnN0IGlzVGhlbWVQZXJzaXN0ZWQgPSAoKTogYm9vbGVhbiA9PiB7XG4gIGlmICh0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJykgcmV0dXJuIGZhbHNlO1xuXG4gIHRyeSB7XG4gICAgcmV0dXJuIGxvY2FsU3RvcmFnZS5nZXRJdGVtKFRIRU1FX0tFWSkgIT09IG51bGw7XG4gIH0gY2F0Y2gge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufTtcblxuZXhwb3J0IGRlZmF1bHQge1xuICBnZXRTeXN0ZW1UaGVtZSxcbiAgZ2V0U3RvcmVkVGhlbWUsXG4gIHNldFN0b3JlZFRoZW1lLFxuICBjbGVhclN0b3JlZFRoZW1lLFxuICBtaWdyYXRlVGhlbWUsXG4gIHN5bmNUaGVtZVdpdGhTeXN0ZW0sXG4gIGluaXRUaGVtZVBlcnNpc3RlbmNlLFxuICBnZXRUaGVtZUluZm8sXG4gIGlzVGhlbWVQZXJzaXN0ZWQsXG59O1xuIl0sInZlcnNpb24iOjN9